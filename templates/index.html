<!DOCTYPE html>
<html>
<head>
    <title>ShieldPy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial; padding:20px; }
        #logList {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f9f9f9;
        }
        #logList li { font-size: 14px; margin-bottom: 5px; font-family: monospace; }
        #rules { margin-top:20px; padding:10px; border:1px solid #ccc; background:#eef; }
        .rule-item { margin:5px 0; }
        button { margin-left:10px; }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è ShieldPy Dashboard</h1>

    <h2>Traffic Stats</h2>
    <canvas id="trafficChart" width="400" height="200" style="border:1px solid #ccc; padding:10px;"></canvas>

    <h2>Recent Activity</h2>
    <ul id="logList"></ul>

    <h2>Manage Rules</h2>
    <div id="rules"></div>

    <h3>Add Rule</h3>
    <select id="ruleCategory">
        <option value="blocked_ips">Blocked IP</option>
        <option value="allowed_ports">Allowed Port</option>
        <option value="blocked_protocols">Blocked Protocol</option>
    </select>
    <input type="text" id="ruleValue" placeholder="Enter value (IP, Port, Protocol)">
    <button onclick="addRule()">Add Rule</button>

    <script>
        // === Chart ===
        const ctx = document.getElementById('trafficChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'pie',
            data: { labels: ['Allowed', 'Blocked'], datasets: [{ data: [0,0], backgroundColor: ['green','red'] }] },
            options: { responsive:false, plugins:{ legend:{ position:'bottom' } } }
        });

        async function fetchStats() {
            const res = await fetch("/stats"); const data = await res.json();
            chart.data.datasets[0].data = [data.allowed, data.blocked];
            chart.update();
        }

        async function fetchLogs() {
            const res = await fetch("/logs"); const logs = await res.json();
            const logList = document.getElementById("logList");
            logList.innerHTML = "";
            logs.reverse().forEach(log => {
                const li = document.createElement("li");
                li.textContent = log;
                logList.appendChild(li);
            });
            logList.scrollTop = 0;
        }

        async function fetchRules() {
            const res = await fetch("/rules");
            const rules = await res.json();
            const rulesDiv = document.getElementById("rules");
            rulesDiv.innerHTML = "";

            for (const category in rules) {
                const h4 = document.createElement("h4");
                h4.textContent = category;
                rulesDiv.appendChild(h4);

                rules[category].forEach(value => {
                    const div = document.createElement("div");
                    div.className = "rule-item";
                    div.textContent = value;

                    const btn = document.createElement("button");
                    btn.textContent = "Remove";
                    btn.onclick = () => removeRule(category, value);

                    div.appendChild(btn);
                    rulesDiv.appendChild(div);
                });
            }
        }

        async function addRule() {
            const category = document.getElementById("ruleCategory").value;
            const value = document.getElementById("ruleValue").value.trim();
            if (!value) return alert("Please enter a value");
            await fetch("/add_rule", {
                method:"POST", headers:{ "Content-Type":"application/json" },
                body: JSON.stringify({ category, value })
            });
            document.getElementById("ruleValue").value = "";
            fetchRules();
        }

        async function removeRule(category, value) {
            await fetch("/remove_rule", {
                method:"POST", headers:{ "Content-Type":"application/json" },
                body: JSON.stringify({ category, value })
            });
            fetchRules();
        }

        setInterval(fetchStats, 2000);
        setInterval(fetchLogs, 2000);
        setInterval(fetchRules, 5000);
        fetchStats(); fetchLogs(); fetchRules();
    </script>
</body>
</html>
